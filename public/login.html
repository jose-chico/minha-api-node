<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login</title>
  <style>
    :root{ --bg:#0a0f0a; --card:#0f1710; --text:#ecfdf5; --muted:#b7f7ce;
      --accent:#34d399; --border:#1e2a1f; --input:#0d140e; --shadow:0 10px 30px rgba(0,0,0,.25); }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,Segoe UI,Roboto; color:var(--text);
      background: radial-gradient(1200px 800px at 80% -10%, rgba(52,211,153,.14), transparent 60%),
                  radial-gradient(900px 700px at -10% 110%, rgba(16,185,129,.10), transparent 60%),
                  linear-gradient(180deg,#081108,#0a0f0a);
      min-height:100vh; display:grid; place-items:center;
    }
    .card{width:100%; max-width:420px; background:linear-gradient(180deg,rgba(52,211,153,.06),transparent 40%), var(--card);
      border:1px solid var(--border); border-radius:18px; padding:22px; box-shadow:var(--shadow)}
    h1{margin:0 0 10px}
    .grid{display:grid; gap:12px}
    .row{display:flex; justify-content:flex-end; align-items:center}
    .input{background:var(--input); border:1px solid var(--border); border-radius:12px; color:var(--text); padding:12px 14px; outline:none}
    .input:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(52,211,153,.12)}
    .btn{background:var(--accent); border:1px solid transparent; color:#052e1a; font-weight:600; padding:12px 16px; border-radius:12px; cursor:pointer}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .muted{color:var(--muted); font-size:14px}
    .error{color:#fecaca}
    .link{color:var(--muted); font-size:14px; text-decoration:underline; cursor:pointer}
    .link:hover{color:var(--accent)}
    .forgot{display:none; gap:10px; margin-top:4px; padding:12px; border:1px solid var(--border); border-radius:12px;
      background:linear-gradient(180deg,rgba(52,211,153,.04),transparent 70%), var(--card)}
    .forgot .title{margin:0 0 4px; font-size:16px}
    .small{font-size:13px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Entrar</h1>
    <div class="grid">
      <input id="email" class="input" type="email" placeholder="Email" autocomplete="username" />
      <input id="senha" class="input" type="password" placeholder="Senha" autocomplete="current-password" />

      <div class="row">
        <a id="forgotLink" class="link">Esqueci minha senha?</a>
      </div>

      <button id="btnLogin" class="btn" disabled>Entrar</button>
      <div id="msg" class="muted"></div>

      <div id="forgotArea" class="forgot">
        <div>
          <h3 class="title">Recuperar senha</h3>
          <p class="muted small">Informe seu e-mail para enviarmos o link de redefinição.</p>
        </div>
        <input id="forgotEmail" class="input" type="email" placeholder="Seu e-mail" />
        <button id="btnForgot" class="btn" disabled>Enviar link</button>
        <div id="msgForgot" class="muted"></div>
        <div class="row">
          <a id="backToLogin" class="link small">Voltar ao login</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    const els = {
      email: document.getElementById('email'),
      senha: document.getElementById('senha'),
      btnLogin: document.getElementById('btnLogin'),
      msg: document.getElementById('msg'),
      forgotLink: document.getElementById('forgotLink'),
      forgotArea: document.getElementById('forgotArea'),
      forgotEmail: document.getElementById('forgotEmail'),
      btnForgot: document.getElementById('btnForgot'),
      msgForgot: document.getElementById('msgForgot'),
      backToLogin: document.getElementById('backToLogin'),
    };

    // Base da API (usa o mesmo domínio quando hospedado no Render)
    const API = (() => {
      const saved = localStorage.getItem('apiBase');
      if (saved) return saved.replace(/\/+$/, '');
      const origin = window.location.origin;
      if (origin && origin.startsWith('http')) return origin; // páginas servidas pela própria API
      return 'https://minha-api-node-p0p6.onrender.com';       // fallback
    })();

    // Utilitários
    function setMsg(t, cls=''){ els.msg.textContent = t || ''; els.msg.className = 'muted ' + cls; }
    function setMsgForgot(t, cls=''){ els.msgForgot.textContent = t || ''; els.msgForgot.className = 'muted ' + cls; }
    function validEmail(v){ return /\S+@\S+\.\S+/.test(v); }
    function toggleLogin(){ els.btnLogin.disabled = !(els.email.value && els.senha.value); }
    function toggleForgot(){ els.btnForgot.disabled = !validEmail(els.forgotEmail.value); }
    function extrairToken(data){
      if(!data) return null;
      if(typeof data === 'string') return data;
      return data.token || data.accessToken || data.jwt || null;
    }
    function msgErro(data, fallback='Erro'){
      if (!data) return fallback;
      if (Array.isArray(data) && data[0]?.message) return data.map(i=>i.message).join(' | ');
      return data.message || fallback;
    }

    els.email.addEventListener('input', toggleLogin);
    els.senha.addEventListener('input', toggleLogin);
    els.forgotEmail && els.forgotEmail.addEventListener('input', toggleForgot);

    // Submit com Enter
    [els.email, els.senha].forEach(i => i.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !els.btnLogin.disabled) els.btnLogin.click();
    }));

    // Login
    els.btnLogin.addEventListener('click', async () => {
      setMsg('Autenticando...');
      els.btnLogin.disabled = true;
      try{
        const res = await fetch(API + '/auth/login', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ email: els.email.value, password: els.senha.value })
        });
        const data = await res.json().catch(()=>({}));

        if(res.status === 404){
          setMsg('Usuário não encontrado. Redirecionando para cadastro...', 'error');
          setTimeout(()=>{
            localStorage.setItem('emailParaCadastro', els.email.value);
            window.location.href = 'cadastrar.html';
          }, 1200);
          return;
        }
        if(!res.ok) throw new Error(msgErro(data, 'Falha no login'));

        const token = extrairToken(data);
        if(!token) throw new Error('Token não encontrado na resposta.');

        localStorage.setItem('token', token);
        localStorage.setItem('email', els.email.value);
        setMsg('Login ok! Redirecionando...');
        window.location.href = 'listar-clientes.html';
      }catch(err){
        setMsg(err.message || 'Erro', 'error');
      }finally{
        toggleLogin();
      }
    });

    // Esqueci minha senha
    els.forgotLink.addEventListener('click', () => {
      els.forgotArea.style.display = 'grid';
      els.forgotEmail.value = els.email.value || '';
      setMsgForgot('');
      toggleForgot();
      els.forgotEmail.focus();
      setTimeout(()=>els.forgotArea.scrollIntoView({behavior:'smooth', block:'center'}), 0);
    });

    els.backToLogin.addEventListener('click', () => {
      els.forgotArea.style.display = 'none';
      setMsgForgot('');
    });

    els.btnForgot.addEventListener('click', async () => {
      setMsgForgot('Enviando e-mail...');
      els.btnForgot.disabled = true;
      try{
        const res = await fetch(API + '/auth/forgot-password', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ email: els.forgotEmail.value })
        });
        await res.json().catch(()=>({}));
        setMsgForgot('Se o e-mail existir, enviaremos um link para redefinição.');
        setTimeout(()=>toggleForgot(), 1200);
      }catch(err){
        setMsgForgot('Não foi possível enviar agora. Tente novamente em instantes.', 'error');
      }finally{
        toggleForgot();
      }
    });
  </script>
</body>
</html>
