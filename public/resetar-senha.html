<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Redefinir senha</title>
  <style>
    :root{ --bg:#0a0f0a; --card:#0f1710; --text:#ecfdf5; --muted:#b7f7ce; --accent:#34d399; --border:#1e2a1f; --input:#0d140e; --shadow:0 10px 30px rgba(0,0,0,.25) }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,Segoe UI,Roboto; color:var(--text);
      background: radial-gradient(1200px 800px at 80% -10%, rgba(52,211,153,.14), transparent 60%),
                  radial-gradient(900px 700px at -10% 110%, rgba(16,185,129,.10), transparent 60%),
                  linear-gradient(180deg,#081108,#0a0f0a);
      min-height:100vh; display:grid; place-items:center; }
    .card{width:100%; max-width:420px; background:linear-gradient(180deg,rgba(52,211,153,.06),transparent 40%), var(--card); border:1px solid var(--border); border-radius:18px; padding:22px; box-shadow:var(--shadow)}
    h1{margin:0 0 10px}
    .grid{display:grid; gap:12px}
    .input{background:var(--input); border:1px solid var(--border); border-radius:12px; color:var(--text); padding:12px 14px; outline:none}
    .input:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(52,211,153,.12)}
    .btn{background:var(--accent); border:1px solid transparent; color:#052e1a; font-weight:600; padding:12px 16px; border-radius:12px; cursor:pointer}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .muted{color:var(--muted); font-size:14px}
    .error{color:#fecaca}
    .row{display:flex; gap:8px; align-items:center}
    .small{font-size:13px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Redefinir senha</h1>
    <div id="noToken" class="muted error" style="display:none">Link inválido: token ausente.</div>

    <div class="grid" id="formArea" style="display:none">
      <input id="senha" class="input" type="password" placeholder="Nova senha (mín. 6)" autocomplete="new-password" />
      <input id="senha2" class="input" type="password" placeholder="Confirmar nova senha" autocomplete="new-password" />
      <div class="row small muted">
        <input id="show" type="checkbox" /> <label for="show">Mostrar senha</label>
      </div>
      <button id="btnReset" class="btn" type="button" disabled>Trocar senha</button>
      <div id="msg" class="muted"></div>
      <a href="login.html" class="small" style="text-decoration:underline; color:var(--muted)">Voltar ao login</a>
    </div>
  </div>

  <script>
    const els = {
      senha: document.getElementById('senha'),
      senha2: document.getElementById('senha2'),
      btn: document.getElementById('btnReset'),
      msg: document.getElementById('msg'),
      show: document.getElementById('show'),
      noToken: document.getElementById('noToken'),
      formArea: document.getElementById('formArea'),
    };

    const API = (() => {
      const saved = localStorage.getItem('apiBase');
      if (saved) return saved.replace(/\/+$/, '');
      const origin = window.location.origin;
      if (origin && origin.startsWith('http')) return origin;
      return 'https://minha-api-node-p0p6.onrender.com';
    })();

    const params = new URLSearchParams(location.search);
    const token = params.get('token');

    if(!token){ els.noToken.style.display = 'block'; } else { els.formArea.style.display = 'grid'; }

    function setMsg(t, cls=''){ els.msg.textContent = t || ''; els.msg.className = 'muted ' + cls; }
    function canSubmit(){ return els.senha.value.length>=6 && els.senha.value===els.senha2.value; }
    function toggle(){ els.btn.disabled = !canSubmit(); }

    [els.senha, els.senha2].forEach(i => {
      i.addEventListener('input', toggle);
      i.addEventListener('keydown', e => { if(e.key==='Enter' && !els.btn.disabled) els.btn.click(); });
    });

    els.show.addEventListener('change', () => {
      const type = els.show.checked ? 'text' : 'password';
      els.senha.type = type; els.senha2.type = type;
    });

    els.btn.addEventListener('click', async () => {
      if (!canSubmit()) return;
      setMsg('Trocando senha...'); els.btn.disabled = true;
      try{
        const res = await fetch(API + '/auth/reset-password', {
          method:'POST', headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ token, password: els.senha.value })
        });
        const data = await res.json().catch(()=>({}));
        if(res.status === 400){ setMsg(data?.message || 'Token inválido ou expirado.', 'error'); return; }
        if(res.status === 401){ setMsg('Não autorizado.', 'error'); return; }
        if(!res.ok){
          const txt = Array.isArray(data) ? data.map(i=>i.message).join(' | ') : (data.message || 'Erro');
          throw new Error(txt);
        }
        setMsg('Senha alterada com sucesso. Você já pode entrar!');
        setTimeout(()=> location.href='login.html', 1400);
      }catch(err){ setMsg(err.message || 'Erro ao redefinir senha.', 'error'); }
      finally{ toggle(); }
    });

    toggle();
  </script>
</body>
</html>
